---
title: Detailed Analysis
author: Lisa Hu, Niek Scholten
output:
  pdf_document:
    latex_engine: xelatex
---
```{r setup, include = FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(error = FALSE)

packages <- c("deSolve", "ggplot2", "formatR", "scales")
invisible(lapply(packages, library, character.only = T))
```

# Assignment 1
# Data loading
```{r data-loading}
## Read the data
MPL_data <- read.csv("MPL.csv", na.strings = "NA")
names(MPL_data)[4:5] <- c("R.m0", "R.0")

## Subset per dose
data_01 <- subset(MPL_data, MPL_data$dose == 0 | MPL_data$dose == 0.1)
data_03 <- subset(MPL_data, MPL_data$dose == 0 | MPL_data$dose == 0.3)

## Create the medians subsets
medians <- aggregate(MPL_data[,c("MPL_conc","R.m0","R.0")],
                     list(MPL_data$dose, MPL_data$time), median, na.rm=T)
names(medians)[1:2] <- c("dose","time")

median_01 <- subset(medians, medians$dose == 0 | medians$dose == 0.1)
median_03 <- subset(medians, medians$dose == 0 | medians$dose == 0.3)

## Function that calculates D
calc.D <- function(dose){
  return( (dose * 1000)/374.471 )
}
```
\newpage
## Implement the model
Following experiments with methylprednisolone in rats, a set of values for the model is defined:

| Parameter | Value   | Unit     | Explanation                                                               |
|-----------|---------|----------|---------------------------------------------------------------------------|
| k~s_Rm~   | 2.90    | fmol/g   | Zero-order rate constant: GR mRNA synthesis                               |
| IC~50_Rm~ | 26.2    | fmol/mg  | Concentration DR(N) that inhibits mRNA synthesis (50%)                    |
| k~on~     | 0.00329 | L/nmol/h | Second-order rate constant: forming MPL-receptor complex                  |
| k~T~      | 0.63    | 1/h      | First-order rate constant: translocation of receptor (cytosol -> nucleus) |
| k~re      | 0.57    | 1/h      | First-order rate constant: recovery of receptor (nucleus -> cytosol)      |
| R~f~      | 0.49    | -        | Fraction free receptor that gets recycled                                 |
| k~d_R~    | 0.0572  | 1/h      | First-order rate constant: breakdown of receptor                          |
| k~d_Rm~   | 0.612   | -        | First-order rate constant: breakdown of GR mRNA                           |
| k~s_R~    | 3.22    | -        | First-order rate constant: production of receptor                         |
| D         | ~       | nmol/L   | Concentration MPL (Calculated with molecular weight = 374.471             |
Table: Parameter values for MPL

| Parameter            | Value | Unit    | Explanation                  |
|----------------------|-------|---------|------------------------------|
| R~m0~ (mRNA)         | 4.74  | fmol/g  | Concentration mRNA~R~        |
| R~0~ (Free_receptor) | 267   | fmol/mg | Concentration free receptors |
| DR                   | 0     | fmol/mg | MPL in the cytosol           |
| DR(N)                | 0     | fmol/mg | MPL in the nucleus           |
Table: Initial values for MPL

The experiment followed rats for 7 days under constant infusion of the drug: 0.1 or 0.3 mg~drug~/kg~rat~/h.
With this information, models can be created:
```{r model}
## Set the model data
params <- c(
        k.s_Rm = 2.90,
        IC.50_Rm = 26.2,
        k.on = 0.00329,
        k.T = 0.63,
        k.re = 0.57,
        R.f = 0.49,
        k.d_R = 0.0572,
        k.d_Rm = 0.612,
        k.s_R = 3.22,
        D = 0
)

state <- c(
        R.m0 = 4.74,
        R.0 = 267,
        DR = 0,
        DRN = 0
)

times <- seq(0, 168, by = 1)

## Model function
grd_model <- function(t, y, parms){
  with(as.list(c(parms, y)),{
    delta.mRNA_R <- k.s_Rm * (1 - ( DRN / (IC.50_Rm + DRN) ) ) - k.d_Rm * R.m0
    delta.R <- k.s_R * R.m0 + R.f * k.re * DRN - k.on * D * R.0 - k.d_R * R.0
    delta.DR <- k.on * D * R.0 - k.T * DR
    delta.DRN <- k.T * DR - k.re * DRN
    return( list( c(delta.mRNA_R, delta.R, delta.DR, delta.DRN ) ) )
  })
}

## Create the models with the different medians
params$D <- calc.D( median(MPL_data$MPL_conc[MPL_data$dose==0.1], na.rm=T) )
model_01 <- ode(times = times, y = state,
                 parms = params, func = grd_model, method = "euler")
model_01 <- as.data.frame(model_01)

params$D <- calc.D( median(MPL_data$MPL_conc[MPL_data$dose==0.3], na.rm=T) )
model_03 <- ode(times = times, y = state,
                 parms = params, func = grd_model, method = "euler")
model_03 <- as.data.frame(model_03)
```

Visualizing these models give the following:
```{r plot}
ggplot(data = data_01, mapping = aes(x = time, y = R.m0)) +
        geom_point(size = 1, shape = 1, aes(color = "Experiment") ) +
        geom_line(data = median_01, aes(color = "Median")) +
        geom_line(data = model_01, aes(color = "Model")) +
labs(x = "Time", y = expression("mRNA"["R"]*" (fmol/g)"),
             title = expression("mRNA"["R"]*" concentration of dose 0.1") ) +
        theme(legend.position = "bottom") +
        scale_colour_manual(values = c("black", "red", "black"),
                            limits = c("Experiment", "Median", "Model") ) +
        guides(color = guide_legend(title = "",
                                    override.aes = list(linetype = c(1, 1, NA),
                                                        shape = c(NA, NA, 1)) ) )

ggplot(data = data_03, mapping = aes(x = time, y = R.m0)) +
        geom_point(size = 1, shape = 1, aes(color = "Experiment") ) +
        geom_line(data = median_03, aes(color = "Median")) +
        geom_line(data = model_03, aes(color = "Model")) +
labs(x = "Time", y = expression("mRNA"["R"]*" (fmol/g)"),
             title = expression("mRNA"["R"]*" concentration of dose 0.3") ) +
        theme(legend.position = "bottom") +
        scale_colour_manual(values = c("black", "red", "black"),
                            limits = c("Experiment", "Median", "Model") ) +
        guides(color = guide_legend(title = "",
                                    override.aes = list(linetype = c(1, 1, NA),
                                                        shape = c(NA, NA, 1)) ) )

ggplot(data = data_01, mapping = aes(x = time, y = R.0)) +
        geom_point(size = 1, shape = 1, aes(color = "Experiment") ) +
        geom_line(data = median_01, aes(color = "Median")) +
        geom_line(data = model_01, aes(color = "Model")) +
        labs(x = "Time", y = "Free receptor concentration (fmol/mg)",
             title = "Free receptor concentration of dose 0.1") +
        theme(legend.position = "bottom") +
        scale_colour_manual(values = c("black", "red", "black"),
                            limits = c("Experiment", "Median", "Model") ) +
        guides(color = guide_legend(title = "",
                                    override.aes = list(linetype = c(1, 1, NA),
                                                        shape = c(NA, NA, 1)) ) )

ggplot(data = data_03, mapping = aes(x = time, y = R.0)) +
        geom_point(size = 1, shape = 1, aes(color = "Experiment") ) +
        geom_line(data = median_03, aes(color = "Median")) +
        geom_line(data = model_03, aes(color = "Model")) +
        labs(x = "Time", y = "Free receptor concentration (fmol/mg)",
             title = "Free receptor concentration of dose 0.3") +
        theme(legend.position = "bottom") +
        scale_colour_manual(values = c("black", "red", "black"),
                            limits = c("Experiment", "Median", "Model") ) +
        guides(color = guide_legend(title = "",
                                    override.aes = list(linetype = c(1, 1, NA),
                                                        shape = c(NA, NA, 1)) ) )
```

## Questions

* [1] Why is it best practice to plot the median for the experimental data?

> The median does not change with huge outliers, so the data is more reliable. If there is a significant difference, it will show.

* [2] How do the results of the simulations depend on the dose and concentration of the drug?

> The dose can influence the steady state of the different concentrations. The shape of the median lines is generally unaffected.

* [3] Are the results of the model in line with experimental data?

> Yes, to some extent. The values that the experiment and the model end on is similar, but the values between the start and the end fluctuate a bit. The graphs of the free receptor concentration show that the experimental data conform with the model. In the mRNA graphs, there are some deviations from the model around Time = 25.

# Assignment 2

## No Auto-Regulation Glucocorticoid Receptor

```{r nodrugs}
## Create function for no drugs
receptor_noDrugs <- function(t, y, parms){
  with(as.list(c(parms, y)),{
    delta.R.m0 <- -k.d_Rm * R.m0
    delta.R <- k.s_R * R.m0 + R.f * k.re * DRN - k.on * D * R.0 - k.d_R * R.0
    delta.DR <- k.on * D * R.0 - k.T * DR
    delta.DRN <- k.T * DR - k.re * DRN
    return( list( c(delta.R.m0, delta.R, delta.DR, delta.DRN ) ) )
  })
}

## The model with a dose of 20
params$D <- calc.D(20)
model_20 <- ode(times = times, y = state,
                 parms = params, func = grd_model, method = "euler")
model_20 <- as.data.frame(model_20)

## The model without drug influence
model_noDrugs <- as.data.frame(ode(times = times, y = state,
                 parms = params, func = receptor_noDrugs, method = "euler"))

ggplot(data = MPL_data, mapping = aes(x = time, y = R.m0)) +
        geom_line(data = model_noDrugs, linetype = "solid", aes(color = "No drugs")) +
        geom_line(data = model_20, linetype = "solid", aes(color = "Model 20")) +
        labs(x = "Time", y = expression("mRNA"["R"]*" (fmol/g)"),
             title = expression("mRNA"["R"]*" concentration") ) +
        scale_colour_manual(values = c("red", "blue"), limits = c("No drugs", "Model 20"))

ggplot(data = MPL_data, mapping = aes(x = time, y = R.0)) +
        geom_line(data = model_noDrugs, linetype = "solid", aes(color = "No drugs")) +
        geom_line(data = model_20, linetype = "solid", aes(color = "Model 20")) +
        labs(x = "Time", y = "Free receptor concentration (fmol/mg)",
             title = "Free receptor concentration") +
        scale_colour_manual(values = c("red", "blue"), limits = c("No drugs", "Model 20"))
```
When the DR(N) has no influence on the mRNA~R~ synthesis, a big part of the first equation disappears: $k_{s_Rm}\cdot(1-\frac{DR(N)}{IC_{50_Rm}+DR(N)})$
The figures show, when DR(N) has no influence on the mRNA~R~ synthesis, the mRNA~R~ concentration drops to zero fairly quickly and stays zero due to no mRNA~R~ synthesis.
The blue line details the normal scenario in which the drug is working correctly with a dose of 20.

## Stopping drug treatment at Steady State

```{r steady-state}
## Define new model
steady_model <- function(t, y, parms){
  with(as.list(c(parms, y)),{
    delta.mRNA_R <- k.s_Rm * (1 - ( DRN / (IC.50_Rm + DRN) ) ) - k.d_Rm * R.m0
    delta.R <- k.s_R * R.m0 + R.f * k.re * DRN - k.on * D * R.0 - k.d_R * R.0
    delta.DR <- k.on * D * R.0 - k.T * DR
    delta.DRN <- k.T * DR - k.re * DRN
    delta.D <- 0
    return( list( c(delta.mRNA_R, delta.R, delta.DR, delta.DRN, delta.D) ) )
  })
}

## Parameters for the steady state model
params_steady <- c(
        k.s_Rm = 2.90,
        IC.50_Rm = 26.2,
        k.on = 0.00329,
        k.T = 0.63,
        k.re = 0.57,
        R.f = 0.49,
        k.d_R = 0.0572,
        k.d_Rm = 0.612,
        k.s_R = 3.22
)

## State parameters for steady state model
state_steady <- c(
        R.m0 = 4.74,
        R.0 = 267,
        DR = 0,
        DRN = 0,
        D = calc.D(20)
)

## Create the event for the model (this will happen when steady state is found
trigger <- function(t, y, params){
  y["D"] <- 0
  return(y)
}

## Check when the steady state is found
root <- function (t, y, params){
  x <- unlist(grd_model(t, y, params))
  numb1 <- sum(abs(x)) - 1e-4
  numb2 <- numb1 + y["D"]

  return(c(numb1, numb2))
}

## Create the model with the turnover
steadys <- ode( times = times, y = state_steady, parms = params_steady,
                func = steady_model, rootfun = root,
                events = list(func = trigger, root = TRUE, terminalroot = 2) )

## The step where steady state was found
cat("Steady state at:", attributes(steadys)$troot)

steadys <- as.data.frame(steadys)

## Create plots
ggplot(data = steadys, mapping = aes(x = time, y = R.m0)) +
        geom_line(aes(color = "Turnover")) +
        geom_line(data = model_20, aes(color = "Model 20")) +
        labs(x = "Time", y = expression("mRNA"["R"]*" (fmol/g)"),
             title = expression("mRNA"["R"]*" concentration") )

ggplot(data = steadys, mapping = aes(x = time, y = R.0)) +
        geom_line(aes(color = "Turnover")) +
        geom_line(data = model_20, aes(color = "Model 20")) +
        labs(x = "Time", y = "Free receptor concentration (fmol/mg)",
             title = "Free receptor concentration")

ggplot(data = steadys, mapping = aes(x = time, y = DR)) +
        geom_line(aes(color = "Turnover")) +
        geom_line(data = model_20, aes(color = "Model 20")) +
        labs(x = "Time", y = "Receptor (fmol/mg)",
             title = "Receptor complex in cytosol")

ggplot(data = steadys, mapping = aes(x = time, y = DRN)) +
        geom_line(aes(color = "Turnover")) +
        geom_line(data = model_20, aes(color = "Model 20")) +
        labs(x = "Time", y = "Receptor (fmol/mg)",
             title = "Receptor complex in Nucleus")

```

## Changes in k~on~ and k~re~

```{r kondiff, message = F}
## Different times values due to conflict in results
times <- seq(0, 48, by=0.01)

state <- c(
        R.m0 = 4.74,
        R.0 = 267,
        DR = 0,
        DRN = 0
)

params <- c(
        k.s_Rm = 2.90,
        IC.50_Rm = 26.2,
        k.on = 0.00329,
        k.T = 0.63,
        k.re = 0.57,
        R.f = 0.49,
        k.d_R = 0.0572,
        k.d_Rm = 0.612,
        k.s_R = 3.22,
        D = calc.D(20)
)

group.cols <- hue_pal()(5)
## Assign each colour for legibility
colours <- c("5 less" = group.cols[1], "2 less" = group.cols[2],
             "2 more" = group.cols[3], "5 more" = group.cols[4],
             "ref" = group.cols[5])

model_k.on_ref <- as.data.frame(ode(times = times, y = state,
                 parms = params, func = grd_model, method = "euler"))

params$k.on <- 0.0039/5

model_k.on_min5 <- as.data.frame(ode(times = times, y = state,
                 parms = params, func = grd_model, method = "euler"))

params$k.on <- 0.0039/2

model_k.on_min2 <- as.data.frame(ode(times = times, y = state,
                 parms = params, func = grd_model, method = "euler"))

params$k.on <- 0.0039*2

model_k.on_plus2 <- as.data.frame(ode(times = times, y = state,
                 parms = params, func = grd_model, method = "euler"))

params$k.on <- 0.0039*5

model_k.on_plus5 <- as.data.frame(ode(times = times, y = state,
                 parms = params, func = grd_model, method = "euler"))

ggplot(mapping = aes(x = time, y = R.m0)) +
        geom_line(data = model_k.on_ref, linetype = "dashed", aes(color = "ref")) +
        geom_line(data = model_k.on_min5, aes(color = "5 less")) +
        geom_line(data = model_k.on_min2, aes(color = "2 less")) +
        geom_line(data = model_k.on_plus2, aes(color = "2 more")) +
        geom_line(data = model_k.on_plus5, aes(color = "5 more")) +
        labs(x = "Time", y = "mRNA (fmol/g)", title = "mRNA over time") +
        theme(legend.position = "bottom") +
        scale_colour_manual(name = "", values = group.cols,
                            limits = names(colours)) +
        guides(color = guide_legend(title = "",
                                    override.aes = list(linetype = c(2, 1, 1, 1, 1) ) ) )

ggplot(mapping = aes(x = time, y = R.0)) +
        geom_line(data = model_k.on_ref, linetype = "dashed", aes(color = "ref")) +
        geom_line(data = model_k.on_min5, aes(color = "5 less")) +
        geom_line(data = model_k.on_min2, aes(color = "2 less")) +
        geom_line(data = model_k.on_plus2, aes(color = "2 more")) +
        geom_line(data = model_k.on_plus5, aes(color = "5 more")) +
        labs(x = "Time", y = "Free receptor concentration (fmol/mg)",
             title = "Free receptor concentration over time") +
        theme(legend.position = "bottom") +
        scale_colour_manual(name = "", values = group.cols,
                            limits = names(colours)) +
        guides(color = guide_legend(title = "",
                                    override.aes = list(linetype = c(2, 1, 1, 1, 1) ) ) )
```

```{r krediff, eval = F}
model_k.re_ref <- as.data.frame(ode(times = times, y = state,
                 parms = params, func = grd_model, method = "euler"))

params$k.re <- 0.57/5

model_k.re_min5 <- as.data.frame(ode(times = times, y = state,
                 parms = params, func = grd_model, method = "euler"))

params$k.re <- 0.57/2

model_k.re_min2 <- as.data.frame(ode(times = times, y = state,
                 parms = params, func = grd_model, method = "euler"))

params$k.re <- 0.57*2

model_k.re_plus2 <- as.data.frame(ode(times = times, y = state,
                 parms = params, func = grd_model, method = "euler"))

params$k.re <- 0.57*5

model_k.re_plus5 <- as.data.frame(ode(times = times, y = state,
                 parms = params, func = grd_model, method = "euler"))

ggplot(data = model_k.re_ref, mapping = aes(x = time, y = R.m0)) +
        geom_line(linetype = "dashed", aes(color = "ref")) +
        geom_line(data = model_k.re_min5, aes(color = "5 less")) +
        geom_line(data = model_k.re_min2, aes(color = "2 less")) +
        geom_line(data = model_k.re_plus2, aes(color = "2 more")) +
        geom_line(data = model_k.re_plus5, aes(color = "5 more")) +
        labs(x = "Time", y = "mRNA (fmol/g)", title = "mRNA over time") +
        theme(legend.position = "bottom") +
        scale_colour_manual(name = "", values = group.cols,
                            limits = names(colours)) +
        guides(color = guide_legend(title = "",
                                    override.aes = list(linetype = c(2, 1, 1, 1, 1) ) ) )

ggplot(data = model_k.re_ref, mapping = aes(x = time, y = R.0)) +
        geom_line(linetype = "dashed", aes(color = "ref")) +
        geom_line(data = model_k.re_min5, aes(color = "5 less")) +
        geom_line(data = model_k.re_min2, aes(color = "2 less")) +
        geom_line(data = model_k.re_plus2, aes(color = "2 more")) +
        geom_line(data = model_k.re_plus5, aes(color = "5 more")) +
        labs(x = "Time", y = "Free receptor concentration (fmol/mg)",
             title = "Free receptor concentration over time") +
        theme(legend.position = "bottom") +
        scale_colour_manual(name = "", values = group.cols,
                            limits = names(colours)) +
        guides(color = guide_legend(title = "",
                                    override.aes = list(linetype = c(2, 1, 1, 1, 1) ) ) )
```

## Block Synthesis of Receptor

To simulate this situation, k~s_R~, R~f~ and k~re~ need to be put to zero.

```{r receptor_block}
params <- c(
        k.s_Rm = 2.90,
        IC.50_Rm = 26.2,
        k.on = 0.00329,
        k.T = 0.63,
        k.re = 0,
        R.f = 0,
        k.d_R = 0.0572,
        k.d_Rm = 0.612,
        k.s_R = 0,
        D = calc.D(20)
)

state <- c(
        R.m0 = 4.74,
        R.0 = 267,
        DR = 0,
        DRN = 0
)
times <- seq(0, 168, by = 1)
no.Receptor <- as.data.frame(ode(times = times, y = state, parms = params,
                                 func = grd_model, method = "euler"))

ggplot(data = no.Receptor, mapping = aes(x = time, y = R.m0)) +
        geom_line(aes(color = "No receptor")) +
        geom_line(data = model_20, aes(color = "Model 20")) +
        labs(x = "mRNA (fmol/g)", y = "Time", title = "No receptor synthesis (mRNA)") +
        scale_colour_manual(name = "", values = c("black", "red"),
                            limits = c("No receptor", "Model 20"))

ggplot(data = no.Receptor, mapping = aes(x = time, y = R.0)) +
        geom_line(aes(color = "No receptor")) +
        geom_line(data = model_20, aes(color = "Model 20")) +
        labs(x = "Free receptor concentration (fmol/mg)", y = "Time",
             title = "No receptor synthesis (Free receptor)") +
        scale_colour_manual(name = "", values = c("black", "red"),
                            limits = c("No receptor", "Model 20"))

ggplot(data = no.Receptor, mapping = aes(x = time, y = DR)) +
        geom_line(aes(color = "No receptor")) +
        geom_line(data = model_20, aes(color = "Model 20")) +
        labs(x = "DR (fmol/mg)", y = "Time", title = "No receptor synthesis (DR)") +
        scale_colour_manual(name = "", values = c("black", "red"),
                            limits = c("No receptor", "Model 20"))

ggplot(data = no.Receptor, mapping = aes(x = time, y = DRN)) +
        geom_line(aes(color = "No receptor")) +
        geom_line(data = model_20, aes(color = "Model 20")) +
        labs(x = "MPL concentration (fmol/mg)", y = "Time",
             title = "No receptor synthesis (MPL concentration)") +
        scale_colour_manual(name = "", values = c("black", "red"),
                            limits = c("No receptor", "Model 20"))
```

## Increased and decreased baseline mRNA production
same as kon kre chunks
